@model IEnumerable<EhjozProject.Domain.Models.Stadium.Stadium>
@{
    ViewData["Title"] = "Stadiums";
}

<!-- Page Header -->
<section class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Browse Stadiums</h1>
        <p class="page-subtitle">Find and book the perfect football field for your next game</p>
    </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
    <div class="filters-card">
        <form id="stadiumFiltersForm" class="filters-form" asp-controller="Stadium" asp-action="Index" method="get" autocomplete="off">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-6 col-lg-3">
                    <label for="city" class="form-label visually-hidden">City</label>
                    <select id="city" name="city" class="form-select form-select-sm" aria-label="City">
                    <option value="">All Cities</option>
                    <option value="beirut" selected="@(ViewBag.SelectedCity == "beirut")">Beirut</option>
                    <option value="tripoli" selected="@(ViewBag.SelectedCity == "tripoli")">Tripoli</option>
                    <option value="sidon" selected="@(ViewBag.SelectedCity == "sidon")">Sidon</option>
                    <option value="jounieh" selected="@(ViewBag.SelectedCity == "jounieh")">Jounieh</option>
                    <option value="zahle" selected="@(ViewBag.SelectedCity == "zahle")">Zahle</option>
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label for="maxPrice" class="form-label visually-hidden">Max Price/Hour</label>
                    <select id="maxPrice" name="maxPrice" class="form-select form-select-sm" aria-label="Max Price per Hour">
                    <option value="">Any Price</option>
                    <option value="30" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "30")">Up to $30</option>
                    <option value="50" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "50")">Up to $50</option>
                    <option value="75" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "75")">Up to $75</option>
                    <option value="100" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "100")">Up to $100</option>
                    </select>
                </div>
                <div class="col-12 col-lg-4">
                    <label for="q" class="form-label visually-hidden">Search</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </span>
                        <input id="q" name="q" value="@(ViewBag.SearchQuery ?? "")" class="form-control" placeholder="Search stadiums..." aria-label="Search stadiums" />
                    </div>
                </div>
                <div class="col-12 col-lg-2 d-flex gap-2">
                    <button id="applyFiltersBtn" type="submit" class="btn btn-success btn-sm flex-grow-1">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                        Apply
                    </button>
                    <a asp-controller="Stadium" asp-action="Index" class="btn btn-outline-secondary btn-sm flex-grow-1">Clear</a>
                </div>
            </div>
        </form>
    </div>
</section>

<div id="stadiumResultsWrap" class="position-relative">
    <div id="stadiumResultsLoading" class="position-absolute top-0 start-0 w-100 h-100 d-none"
         style="background: rgba(255,255,255,.65); z-index: 10;">
        <div class="d-flex h-100 align-items-center justify-content-center">
            <div class="text-center">
                <div class="spinner-border text-success" role="status" aria-label="Loading"></div>
                <div class="text-muted small mt-2">Updating results…</div>
            </div>
        </div>
    </div>

    <div id="stadiumResults">
        @await Html.PartialAsync("_StadiumResults", Model)
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const $form = $('#stadiumFiltersForm');
            const $results = $('#stadiumResults');
            const $loading = $('#stadiumResultsLoading');
            let debounceTimer = null;
            let activeRequest = null;

            function showLoading(on) {
                $loading.toggleClass('d-none', !on);
                $('#applyFiltersBtn').prop('disabled', on);
            }

            function updateUrl(queryString) {
                const newUrl = window.location.pathname + (queryString ? ('?' + queryString) : '');
                window.history.replaceState({}, '', newUrl);
            }

            function fetchResults() {
                const queryString = $form.serialize();
                updateUrl(queryString);

                if (activeRequest && activeRequest.readyState !== 4) {
                    activeRequest.abort();
                }

                showLoading(true);
                activeRequest = $.ajax({
                    url: $form.attr('action'),
                    type: 'GET',
                    data: queryString,
                    cache: false
                }).done(function (html) {
                    // If server returns full view for any reason, extract the partial container as a fallback
                    const $html = $('<div>').append($.parseHTML(html));
                    const partial = $html.find('#stadiumResults').length ? $html.find('#stadiumResults').html() : html;
                    $results.html(partial);
                }).fail(function (xhr, status) {
                    if (status !== 'abort') {
                        $results.html('<div class="alert alert-danger">Could not update results. Please try again.</div>');
                    }
                }).always(function () {
                    showLoading(false);
                });
            }

            function scheduleFetch() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchResults, 250);
            }

            // Prevent full page refresh
            $form.on('submit', function (e) {
                e.preventDefault();
                fetchResults();
            });

            // Auto update on changes
            $form.on('change', 'select', scheduleFetch);
            $form.on('input', '#q', scheduleFetch);
        })();
    </script>
}
