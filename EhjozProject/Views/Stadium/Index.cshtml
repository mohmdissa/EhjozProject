@model IEnumerable<EhjozProject.Domain.Models.Stadium.Stadium>
@{
    ViewData["Title"] = "Stadiums";
}

<!-- Page Header -->
<section class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Browse Stadiums</h1>
        <p class="page-subtitle">Find and book the perfect football field for your next game</p>
    </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
    <form id="stadiumFiltersForm" class="filters-form" asp-controller="Stadium" asp-action="Index" method="get" autocomplete="off">
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label for="city" class="form-label">City</label>
                <select id="city" name="city" class="form-select">
                    <option value="">All Cities</option>
                    <option value="beirut" selected="@(ViewBag.SelectedCity == "beirut")">Beirut</option>
                    <option value="tripoli" selected="@(ViewBag.SelectedCity == "tripoli")">Tripoli</option>
                    <option value="sidon" selected="@(ViewBag.SelectedCity == "sidon")">Sidon</option>
                    <option value="jounieh" selected="@(ViewBag.SelectedCity == "jounieh")">Jounieh</option>
                    <option value="zahle" selected="@(ViewBag.SelectedCity == "zahle")">Zahle</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="maxPrice" class="form-label">Max Price/Hour</label>
                <select id="maxPrice" name="maxPrice" class="form-select">
                    <option value="">Any Price</option>
                    <option value="30" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "30")">Up to $30</option>
                    <option value="50" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "50")">Up to $50</option>
                    <option value="75" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "75")">Up to $75</option>
                    <option value="100" selected="@(ViewBag.SelectedMaxPrice?.ToString() == "100")">Up to $100</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="q" class="form-label">Search</label>
                <input id="q" name="q" value="@(ViewBag.SearchQuery ?? "")" class="form-control" placeholder="Search by name or location..." />
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-3">
                <button id="applyFiltersBtn" type="submit" class="btn btn-success w-100">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Apply Filters
                </button>
            </div>
            <div class="col-md-3">
                <a asp-controller="Stadium" asp-action="Index" class="btn btn-outline-success w-100">Clear</a>
            </div>
            <div class="col-md-6 d-flex align-items-center">
                <small class="text-muted">
                    Tip: filters update automatically as you change them.
                </small>
            </div>
        </div>
    </form>
</section>

<div id="stadiumResultsWrap" class="position-relative">
    <div id="stadiumResultsLoading" class="position-absolute top-0 start-0 w-100 h-100 d-none"
         style="background: rgba(255,255,255,.65); z-index: 10;">
        <div class="d-flex h-100 align-items-center justify-content-center">
            <div class="text-center">
                <div class="spinner-border text-success" role="status" aria-label="Loading"></div>
                <div class="text-muted small mt-2">Updating results…</div>
            </div>
        </div>
    </div>

    <div id="stadiumResults">
        @await Html.PartialAsync("_StadiumResults", Model)
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const $form = $('#stadiumFiltersForm');
            const $results = $('#stadiumResults');
            const $loading = $('#stadiumResultsLoading');
            let debounceTimer = null;
            let activeRequest = null;

            function showLoading(on) {
                $loading.toggleClass('d-none', !on);
                $('#applyFiltersBtn').prop('disabled', on);
            }

            function updateUrl(queryString) {
                const newUrl = window.location.pathname + (queryString ? ('?' + queryString) : '');
                window.history.replaceState({}, '', newUrl);
            }

            function fetchResults() {
                const queryString = $form.serialize();
                updateUrl(queryString);

                if (activeRequest && activeRequest.readyState !== 4) {
                    activeRequest.abort();
                }

                showLoading(true);
                activeRequest = $.ajax({
                    url: $form.attr('action'),
                    type: 'GET',
                    data: queryString,
                    cache: false
                }).done(function (html) {
                    // If server returns full view for any reason, extract the partial container as a fallback
                    const $html = $('<div>').append($.parseHTML(html));
                    const partial = $html.find('#stadiumResults').length ? $html.find('#stadiumResults').html() : html;
                    $results.html(partial);
                }).fail(function (xhr, status) {
                    if (status !== 'abort') {
                        $results.html('<div class="alert alert-danger">Could not update results. Please try again.</div>');
                    }
                }).always(function () {
                    showLoading(false);
                });
            }

            function scheduleFetch() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchResults, 250);
            }

            // Prevent full page refresh
            $form.on('submit', function (e) {
                e.preventDefault();
                fetchResults();
            });

            // Auto update on changes
            $form.on('change', 'select', scheduleFetch);
            $form.on('input', '#q', scheduleFetch);
        })();
    </script>
}
